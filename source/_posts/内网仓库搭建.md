---
title: 内网仓库搭建
date: 2018-03-18 12:13:23
tags: 
    - yum
    - apt-get
categories: linux
---

应对服务器不能去外网的情况
<!--more-->

不同版本的系统,配置等都不一样,过程无二

### yum

#### 通过iso
将对应系统iso挂载到系统(vmware去配置中添加CD)

创建mount文件路径并将CD挂载到系统
`mkdir /mnt/yum-iso`
`mount /dev/cdrom /mnt/yum-iso/`

创建目录,并将iso复制到系统,用来制作yum源
`mkdir /yum` `cp -a /mnt/yum-iso/ /yum/`

备份原有的yum仓库配置
`cd /etc/yum.repos.d/` 
`mkdir bk` 
`mv *.repo bk/`

创建本地yum仓库配置

`vi local-iso.repo`
```
[centos7-iso]
name=CentOS-$releasever - Media
baseurl=file:///yum/yum-iso/
gpgcheck=0
enabled=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7
```

清理缓存,制作本地缓存
`yum clean all`
`yum makecaches`


#### 自定义yum源
安装软件
`yum -y install createrepo`

创建yum源文件目录
`mkdir -p /yum/yum-custom/packages`
将搜集的源放置相应目录
`cp 源文件 /yum/yum-custom/packages/`
创建repo,会生成repodata目录
`createrepo -u -d  /yum/yum-custom/`
配置repo
`cd /etc/yum.repos.d/`
`vi local.repo`
```
[centos7-custom]
name=CentOS-$releasever - Media
baseurl=file:///yum/yum-custom/
gpgcheck=0
enabled=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7
```
清理缓存,制作本地缓存
`yum clean all`
`yum makecaches`

#### 局域网yum源

搭建ftp服务器
`yum -y install vsftpd`
配置ftp
`vi /etc/vsftpd/vsftpd.conf` `anon_root=/yum/`(yum目录权限drwxr-xr-x)
启动ftp
`systemctl start vsftpd` `systemctl enable vsftpd`

其他主机使用此仓库,添加仓库配置文件

`vim /etc/yum.repos.d/local-ftp.repo`

```
[centos7-ftp]
name=CentOS-$releasever - Media
baseurl=ftp://192.168.1.96/yum-custom
gpgcheck=0
enabled=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7
```

### apt-get
等后续



### 镜像yum
主要是导入公网yum制作本地仓库

通过同步[科大开源镜像](http://mirrors.ustc.edu.cn/)到本地,制作局域网仓库
    注:镜像源的选择有很多,前提其支持rsync.

安装同步工具 `yum -y install rsync`
搭建服务器 `yum -y install httpd`
    - web服务器的选择有很多,apache,nginx,ftp等等

编辑同步脚本,注意本地路径和远程一致,方便后续repo文件的书写,其分类很清晰
写个定时任务,闲时同步即可
```
#!/usr/bin/bash
#centos7 x86_64
rsync -av rsync://mirrors.ustc.edu.cn/centos/7/os/x86_64/Packages/  /var/www/html/centos/7/os/x86_64/Packages/  > /var/www/html/log/os7p.log 2>&1
rsync -av rsync://mirrors.ustc.edu.cn/centos/7/os/x86_64/repodata/  /var/www/html/centos/7/os/x86_64/repodata/  > /var/www/html/log/os7r.log 2>&1
rsync -av rsync://mirrors.ustc.edu.cn/centos/7/extras/x86_64/Packages/  /var/www/html/centos/7/extras/x86_64/Packages/  > /var/www/html/log/ex7p.log 2>&1
rsync -av rsync://mirrors.ustc.edu.cn/centos/7/extras/x86_64/repodata/  /var/www/html/centos/7/extras/x86_64/repodata/  > /var/www/html/log/ex7r.log 2>&1
rsync -av rsync://mirrors.ustc.edu.cn/centos/7/updates/x86_64/Packages/  /var/www/html/centos/7/updates/x86_64/Packages/  > /var/www/html/log/up7p.log 2>&1
rsync -av rsync://mirrors.ustc.edu.cn/centos/7/updates/x86_64/repodata/  /var/www/html/centos/7/updates/x86_64/repodata/  > /var/www/html/log/up7r.log 2>&1

#centos6 x86_64
rsync -av rsync://mirrors.ustc.edu.cn/centos/6/os/x86_64/Packages/  /var/www/html/centos/6/os/x86_64/Packages/  > /var/www/html/log/os6p.log 2>&1
rsync -av rsync://mirrors.ustc.edu.cn/centos/6/os/x86_64/repodata/  /var/www/html/centos/6/os/x86_64/repodata/  > /var/www/html/log/os6r.log 2>&1
rsync -av rsync://mirrors.ustc.edu.cn/centos/6/extras/x86_64/Packages/  /var/www/html/centos/6/extras/x86_64/Packages/  > /var/www/html/log/ex6p.log 2>&1
rsync -av rsync://mirrors.ustc.edu.cn/centos/6/extras/x86_64/repodata/  /var/www/html/centos/6/extras/x86_64/repodata/  > /var/www/html/log/ex6r.log 2>&1
rsync -av rsync://mirrors.ustc.edu.cn/centos/6/updates/x86_64/Packages/  /var/www/html/centos/6/updates/x86_64/Packages/  > /var/www/html/log/up6p.log 2>&1
rsync -av rsync://mirrors.ustc.edu.cn/centos/6/updates/x86_64/repodata/  /var/www/html/centos/6/updates/x86_64/repodata/  > /var/www/html/log/up6r.log 2>&1

```
我只同步了三个主要的包,不到30G.(同步前注意自己的磁盘空间)


编辑jk.repo文件.(网址为服务器网址)

```
[base]
name=CentOS-$releasever - Base - jk
baseurl=http://192.168.1.96/centos/$releasever/os/$basearch/
gpgcheck=0

#released updates
[updates]
name=CentOS-$releasever - Updates - jk
baseurl=http://192.168.1.96/centos/$releasever/updates/$basearch/
gpgcheck=0

#additional packages that may be useful
[extras]
name=CentOS-$releasever - Extras - jk
baseurl=httpd://192.168.1.96/centos/$releasever/extras/$basearch/
gpgcheck=0

```

----