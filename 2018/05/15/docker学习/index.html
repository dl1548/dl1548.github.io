<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">
<meta name="theme-color" content="#222">
<script>
    (function(){
        if(''){
            if (prompt('请输入文章密码') !== ''){
                alert('密码错误！');
                location="http://blog.dl1548.site";
            }
        }
    })();
</script>








<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="docker,">










<meta name="description" content="docker">
<meta name="keywords" content="docker">
<meta property="og:type" content="article">
<meta property="og:title" content="docker学习">
<meta property="og:url" content="https://dl1548.github.io/2018/05/15/docker学习/index.html">
<meta property="og:site_name" content="zili的笔记">
<meta property="og:description" content="docker">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2019-05-09T05:52:39.146Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="docker学习">
<meta name="twitter:description" content="docker">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.3',
    sidebar: {"position":"right","display":"post","offset":8,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://dl1548.github.io/2018/05/15/docker学习/">





  <title>docker学习 | zili的笔记</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?b292eae21b9892cd49051ddc886e6534";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-right page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">zili的笔记</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">好记性不如烂笔头~</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-board">
          <a href="/board/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br>
            
            留言
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dl1548.github.io/2018/05/15/docker学习/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zili">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/zili.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zili的笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">docker学习</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-15T21:15:06+08:00">
                2018-05-15
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-comment-o"></i>
              </span>
              
                <a href="/2018/05/15/docker学习/#SOHUCS" itemprop="discussionUrl">
                  <span id="changyan_count_unit" class="post-comments-count hc-comment-count" data-xid="2018/05/15/docker学习/" itemprop="commentsCount"></span>
                </a>
              
            
          

          
          

          

          

          

        </span></div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>docker<br><a id="more"></a></p>
<p>Docker三个基本概念</p>
<ul>
<li>镜像（image）</li>
<li>容器（container）</li>
<li>仓库（rrepository)</li>
</ul>
<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><p>不同系统安装方式不同，<a href="https://github.com/yeasy/docker_practice/blob/master/install/README.md" target="_blank" rel="noopener">详见</a><br>以<code>centos</code>为例(仅支持64位kernel &gt;=3.10)建议使用国内源<br><strong>卸载原有版本</strong><br><code>yum remove docker docker-common docker-selinux docker-engine</code><br>yum-util 提供yum-config-manager功能，另外两个是devicemapper驱动依赖<br><code>yum install -y yum-utils device-mapper-persistent-data lvm2</code><br><strong>添加yum源</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#中科大</span><br><span class="line">sudo yum-config-manager --add-repo https://mirrors.ustc.edu.cn/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"># 官方源</span><br><span class="line"># sudo yum-config-manager  --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure></p>
<p>查看版本<br><code>yum list docker-ce --showduplicates | sort -r</code><br>可选择版本进行安装。默认仓库只开放稳定版<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install docker-ce #默认安装最新稳定版</span><br><span class="line">sudo yum install docker-ce-17.12.0.ce #安装指定版本</span><br></pre></td></tr></table></figure></p>
<p>然后启动并开机启动，<code>docker version</code>即可查看版本</p>
<h4 id="创建用户组"><a href="#创建用户组" class="headerlink" title="创建用户组"></a>创建用户组</h4><p>为了安全起见，docker只允许root和docker用户组的用户进行访问<br><code>groupadd docker</code><br><code>usermod -G docker username</code></p>
<h4 id="镜像加速"><a href="#镜像加速" class="headerlink" title="镜像加速"></a>镜像加速</h4><p>若文件不存在,则手动创建<br><code>vim /etc/docker/daemon.json</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#docker国内镜像加速应该是挂了</span><br><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://registry.docker-cn.com&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#阿里云镜像加速</span><br><span class="line">登陆[阿里云](https://cr.console.aliyun.com),获取专属加速地址</span><br><span class="line">类似 https://xxxx.mirror.aliyuncs.com 替换上面的地址</span><br></pre></td></tr></table></figure></p>
<p>systemctl daemon-reload<br>systemctl restart docker</p>
<h4 id="image"><a href="#image" class="headerlink" title="image"></a>image</h4><p>获取镜像<br><code>docker pull [选项] [ 仓库地址]  仓库名/标签</code> 默认从<code>docker hub</code> 中拉取<br>例如 ： docker pull centos #默认就是从docker hub下载最新的<br>如果需要下载制定tag的，可去官网查询<br><code>docker search xxxx</code> 不显示tag<br><code>docker pull centos:7.4.1708</code> 下载指定版本</p>
<p><code>docker images -a</code>  列出镜像 (显示包括中间层镜像)<br>中间层镜像：是其他镜像所依赖的镜像，不能删除，否则会导致上层镜像因为依赖丢失报错，事实上也无需删除，相同的层只会存储一遍。</p>
<p><code>docker system df</code>  查看镜像,容器,数据卷占用空间</p>
<p><code>docker images -f since(或before)=image name</code> 列出某个image之前(之后)的镜像</p>
<p><code>docker image prune</code>删除虚悬镜像(dangling)<br> 虚悬镜像：也就是新旧镜像重名而导致的，pull和build都可能会出现这种情况，<code>docker image ls -f dangling=true</code>可 查看，虚悬镜像都是无价值的，可删除</p>
<p><code>docker rmi $(docker images -q -f dangling=true)</code>  批量删除dangling</p>
<p><code>docker run --name webserver -d -p 80:80 nginx</code>  以nginx镜像为基础，运行容器，也就是新建个容器</p>
<h5 id="构建镜像"><a href="#构建镜像" class="headerlink" title="构建镜像"></a>构建镜像</h5><h5 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$   mkdir   mynginx</span><br><span class="line">$   cd  mynginx</span><br><span class="line">$   touch   Dockerfile</span><br><span class="line">cat Dockerfile</span><br><span class="line">FROM nginx</span><br><span class="line">RUN echo &apos;&lt;h1&gt;Dockerfile&lt;/h1&gt;&apos; &gt;    &gt; /usr/share/nginx/html/index.html</span><br></pre></td></tr></table></figure>
<p><code>FROM image</code><br>必写,定制镜像也是以镜像为基础的.这里就是选定一个基础镜像,可以以相关服务镜像为基础(nginx,mysql等),也可是是系统(ubuntu,centos等).<br>另外,dicker还提供<code>FROM scratch</code> 意味不以任何镜像为基础.</p>
<p><code>RUN</code><br>shell格式 : 用来执行命令行命令.<br>exec格式: <code>RUN [&quot;可执行文件&quot;,&quot;参数1&quot;,    &quot;参数2&quot;]</code>这像是函数调用<br><code>RUN</code>命令常用来安装软件包</p>
<h6 id="构建"><a href="#构建" class="headerlink" title="构建"></a>构建</h6><p><code>docker build [选项] &lt;上下文路径/URL/-&gt;</code><br>在文件目录下执行<code>docker build -t nginx:v3   .</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@docker docker]# docker build -t nginx:v3 .</span><br><span class="line">Sending build context to Docker daemon  2.048kB</span><br><span class="line">Step 1/2 : FROM nginx</span><br><span class="line"> ---&gt; b8efb18f159b</span><br><span class="line">Step 2/2 : RUN echo &apos;&lt;h1&gt; Dockerfile!&lt;/h1&gt;&apos; &gt;&gt; /usr/share/nginx/html/index.html</span><br><span class="line"> ---&gt; Running in 8b921720af4c</span><br><span class="line"> ---&gt; 2cd0174a0aea</span><br><span class="line">Removing intermediate container 8b921720af4c</span><br><span class="line">Successfully built 2cd0174a0aea</span><br><span class="line">Successfully tagged nginx:v3</span><br></pre></td></tr></table></figure></p>
<h6 id="实例解析"><a href="#实例解析" class="headerlink" title="实例解析"></a>实例解析</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">FROM    debian:jessie</span><br><span class="line">RUN apt-get update</span><br><span class="line">RUN apt-get install -y  gcc libc6-dev   make</span><br><span class="line">RUN wget    -O  redis.tar.gz    &quot;http://download.redis.io/releases/redis-3.2.5.tar.gz&quot;</span><br><span class="line">RUN mkdir   -p  /usr/src/redis</span><br><span class="line">RUN tar -xzf    redis.tar.gz    -C  /usr/src/redis  --strip-components=1</span><br><span class="line">RUN make    -C  /usr/src/redis</span><br><span class="line">RUN make    -C  /usr/src/redis  install</span><br></pre></td></tr></table></figure>
<p>Dockerfile中一个RUN指令,就会建立一层.就和cimmit类似,一层层的叠加然后生成新的image.这样没有意义,很多无用的东西都装进了image.编译环境,软件包等.而且UnionFS是有层数限制的的.<br>所以,正确的写法应该是这样<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">FROM    debian:jessie</span><br><span class="line">RUN buildDeps=&apos;gcc  libc6-dev   make&apos;   \</span><br><span class="line">                &amp;&amp;  apt-get update  \</span><br><span class="line">                &amp;&amp;  apt-get install -y  $buildDeps  \</span><br><span class="line">                &amp;&amp;  wget    -O  redis.tar.gz    &quot;http://download.redis.io/releases/redis-3.2.5.tar.gz&quot;  \</span><br><span class="line">                &amp;&amp;  mkdir   -p  /usr/src/redis  \</span><br><span class="line">                &amp;&amp;  tar -xzf    redis.tar.gz    -C  /usr/src/redis  --strip-components=1    \</span><br><span class="line">                &amp;&amp;  make    -C  /usr/src/redis  \</span><br><span class="line">                &amp;&amp;  make    -C  /usr/src/redis  install \</span><br><span class="line">                &amp;&amp;  rm  -rf /var/lib/apt/lists/*    \</span><br><span class="line">                &amp;&amp;  rm  redis.tar.gz    \</span><br><span class="line">                &amp;&amp;  rm  -r  /usr/src/redis  \</span><br><span class="line">                &amp;&amp;  apt-get purge   -y  --auto-remove   $buildDeps</span><br></pre></td></tr></table></figure></p>
<p>一层一个目的,而不是一层一条命令,我们是在构建image并不是在写shell脚本.并且要记得做相关清理工作.</p>
<h6 id="build中的点"><a href="#build中的点" class="headerlink" title="build中的点."></a>build中的点<code>.</code></h6><p>docker build 命令最后有个点<code>.</code>,它表示当前目录,而Dockerfile就在当前目录.所以会让人认为点<code>.</code>指的就是Dockerfile的路径,其实是不准确的.如果对照bulid格式,会发现,这里的点其实指的是上下文.<br>理解上下文要理解下docker工作原理,docker运行时,分为server和client.我们其实是使用client控制docker服务端,所有的操作其实是服务端完成的.也就是C/S结构.<br>所以我们构建image的时候,可以使用ADD.COPY等指令,将本地文件复制进镜像.构建是在服务端.服务端如何获取本地文件呢?这里就用到了上下文.用户指定了上下文路径,build的时候就会将路径下的内容打包.然后上传到Docker server.当Docker server收到后展开就能获得所需的一切文件<br>比如<br><code>COPY ./package.json /app</code><br>这并不是要复制执行docker build命令所在的目录下的package.json   ,也不是复制Dockerfile所在目录下的package.json而是复制上下文(context)目录下的p<br>ackage.json<br>所以,这里的路径是相对的,   <code>COPY   ../package.json /app</code>或者<code>COPY    /opt/xxxx   /app</code> 其实都已经超出了上下文的范围.那当我们需要context范围外的文件怎么办?很简单,先把文件cp到上下文目录中.<br>默认情况下,Dockerfile会将上下文目录下的Dockerfile文件作为Dockerfile.所以很多人会误认为 <code>.</code>就是指Dockerfile所在目录<br>通常习惯上我们也不会去更改.</p>
<h5 id="Dockerfile其他指令"><a href="#Dockerfile其他指令" class="headerlink" title="Dockerfile其他指令"></a>Dockerfile其他指令</h5><h6 id="COPY"><a href="#COPY" class="headerlink" title="COPY"></a>COPY</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">COPY    &lt;源路径&gt;...    &lt;目标路径&gt;  </span><br><span class="line">COPY    [&quot;&lt;源路径1&gt;&quot;,...   &quot;&lt;目标路径&gt;&quot;]</span><br></pre></td></tr></table></figure>
<p>源路径可以指定多个,也可以是还是用通配符.<br>此COPY 自带 -p.会保留源文件的属性.</p>
<h6 id="ADD"><a href="#ADD" class="headerlink" title="ADD"></a>ADD</h6><p>基本和COPY是一致的.但是他俩的使用建议遵守一个原则<br>文件复制使用<code>COPY</code>,需要解压缩使用<code>ADD</code></p>
<h6 id="CMD"><a href="#CMD" class="headerlink" title="CMD"></a>CMD</h6><p>此命令类似<code>RUN</code> 支持两种格式 <code>shell</code> 和 <code>exec</code><br>shell    格式: <code>CMD   &lt;命令&gt;</code><br>exec格式: <code>CMD    [&quot;可执行文件&quot;,   &quot;参数1&quot;,  &quot;参数2&quot;...]</code><br>参数列表格式: <code>CMD[&quot;参数1&quot;, &quot;参数2&quot;...]</code>在指定了  <code>ENTRYPOINT</code>        指令后,用    CMD指定具体的参数。</p>
<p>Docker不是虚拟机,容器是进程.所以容器的启动需要指定运行程序和参数.<code>CMD</code> 就是用于指定默认容易主进程的启动命令<br>或者这样理解,<code>CMD</code> 执行的是默认容器启动后执行的命令以及参数.一般<code>只允许使用一次CMD,常用于文件最后</code></p>
<p>命令格式上推荐使用<code>exec</code> , 默认情况下 shell 是会被封装成为<code>sh -c</code><br>如:<br><code>CMD echo $HOME</code> –&gt; <code>CMD [&quot;sh&quot;, &quot;-c&quot;, &quot;echo $HOME&quot;]</code><br>注意! <code>exec</code>格式 一定要用双引号!因为在解析时会被解析成<code>json</code></p>
<p>docker不是虚拟机,容器的应用也应该是以前台执行的,容器不存在后台的概念.不能以虚拟机的方式去执行后台服务等<br>所以 <code>CMD  service nginx start</code>肯定是错误的.会转换为 <code>CMD [&quot;sh&quot;, &quot;-c&quot;, &quot;service nginx start&quot;]</code> 显而易见,主进程是<code>sh</code>,所以这种格式的命令,会导致容器退出.<br>正确的方式 是<code>CMD [&quot;nginx&quot;,&quot;-g&quot;,&quot;daemon off&quot;]</code></p>
<h6 id="ENTRYPOINT"><a href="#ENTRYPOINT" class="headerlink" title="ENTRYPOINT"></a>ENTRYPOINT</h6><p>同样支持两种格式: <code>exec</code> 和<code>shell</code></p>
<p>当指定了<code>ENTRYPOINT</code>后<code>CMD</code>的含义就发生了变化,它不在直接运行命令,而是将内容传送给<code>ENTYRPOINT</code>运行<br>同<code>CMD</code>,一个文件只写一次.</p>
<h6 id="ENV"><a href="#ENV" class="headerlink" title="ENV"></a>ENV</h6><p>环境变量<br><code>ENV KEY VALUE</code> <code>ENV KEY=VALUE</code> 两种方式都可以<br>下列指令可以支持环境变量展开：<br><code>ADD、COPY、ENV、EXPOSE、LABEL、USER、WORKDIR、VOLUME、STOPSIGNAL、ONBUILD</code><br>例:(node官方)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ENV NODE_VERSION 7.2.0</span><br><span class="line"></span><br><span class="line">RUN curl -SLO &quot;https://nodejs.org/dist/v$NODE_VERSION/node-v$NODE_VERSION-linux-x64.tar.xz&quot; \</span><br><span class="line">  &amp;&amp; curl -SLO &quot;https://nodejs.org/dist/v$NODE_VERSION/SHASUMS256.txt.asc&quot; \</span><br><span class="line">  &amp;&amp; gpg --batch --decrypt --output SHASUMS256.txt SHASUMS256.txt.asc \</span><br><span class="line">  &amp;&amp; grep &quot; node-v$NODE_VERSION-linux-x64.tar.xz\$&quot; SHASUMS256.txt | sha256sum -c - \</span><br><span class="line">  &amp;&amp; tar -xJf &quot;node-v$NODE_VERSION-linux-x64.tar.xz&quot; -C /usr/local --strip-components=1 \</span><br><span class="line">  &amp;&amp; rm &quot;node-v$NODE_VERSION-linux-x64.tar.xz&quot; SHASUMS256.txt.asc SHASUMS256.txt \</span><br><span class="line">  &amp;&amp; ln -s /usr/local/bin/node /usr/local/bin/nodejs</span><br></pre></td></tr></table></figure></p>
<h6 id="ARG变量"><a href="#ARG变量" class="headerlink" title="ARG变量"></a>ARG变量</h6><p><code>ARG key</code>  <code>ARG key=value</code><br>ARG指令定义的参数，在docker build命令中以–build-arg  key=value形式赋值。<br>ARG变量不像ENV变量始终存在于镜像中。不过ARG变量会以类似的方式对构建缓存产生影响。如果Dockerfile中定义的ARG变量的值与之前定义的变量值不一样，那么就有可能产生“cache miss”。比如RUN指令使用ARG定义的变量时，ARG变量的值变了之后，就会导致缓存失效。</p>
<h6 id="VOLUME"><a href="#VOLUME" class="headerlink" title="VOLUME"></a>VOLUME</h6><p><code>VOLUME path</code> <code>VOLUME [&quot;path1&quot;,&quot;path2&quot;]</code><br>容器运行,尽量让存储层不发生写操作,通常数据都存放在卷中,此命令可实现指定挂载某目录,以防用户忘记将动态文件目录挂载为卷.这样可以保证容器的正常运行,并且不会向存储写数据</p>
<h6 id="EXPOSE"><a href="#EXPOSE" class="headerlink" title="EXPOSE"></a>EXPOSE</h6><p><code>EXPOSE 80</code><br><code>EXPOSE 22</code><br>声明运行容器时提供服务端口,单单只是声明,并不会真的去开启这个端口.当使用<code>docker run -P</code>时,会自动随机映射EXPOSE的端口</p>
<h6 id="WORKDIR"><a href="#WORKDIR" class="headerlink" title="WORKDIR"></a>WORKDIR</h6><p>指定工作目录<br><code>WORKDIR dir</code><br>用来指定工作目录,WORKDIR类似命令cd。<br>WORKDIR参数后可以是相对路径或者带/的绝对路径，使用相对路径就依据上一个WORKDIR参数决定下面的Dockerfile工作目录。<br>可以重复定义，以切换Dockerfile的工作目录。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RUN cd  /app</span><br><span class="line">RUN echo    &quot;hello&quot; &gt;   world.txt</span><br></pre></td></tr></table></figure>
<p>两个RUN 其实是运行了两个容器.第一个RUN并不会对第二个产生任何影响.所以第二个将会找不到路径,此时就需要设置工作目录 <code>WORKDIR /app</code></p>
<h6 id="ONBUILD"><a href="#ONBUILD" class="headerlink" title="ONBUILD"></a>ONBUILD</h6><p>该命令实际上是个触发器,其参数是任意一个Dockerfile 指令<br><code>ONBUILD RUN mkdir /testdir</code><br>当我们在一个Dockerfile文件中加上ONBUILD指令，该指令对利用该Dockerfile构建镜像（比如为A镜像）不会产生实质性影响。<br>但是当我们编写一个新的Dockerfile文件来基于A镜像构建一个镜像（比如为B镜像）时，这时构造A镜像的Dockerfile文件中的ONBUILD指令就生效了.</p>
<h6 id="USER"><a href="#USER" class="headerlink" title="USER"></a>USER</h6><p><code>USER username</code><br><code>USER</code>会改变以后命令的执行用户.或者说,他就是切换用户的.前提,用户是存在的,否则失败.</p>
<p>如果以 root 执行的脚本，在执行期间希望改变身份，比如希望以某个已经建立好的用户来运行某个服务进程<br>不要使用 su 或者 sudo，这些都需要比较麻烦的配置，而且在 TTY 缺失的环境下经常出错。建议使用 gosu。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 建立 redis 用户，并使用 gosu 换另一个用户执行命令</span><br><span class="line">RUN groupadd -r redis &amp;&amp; useradd -r -g redis redis</span><br><span class="line"># 下载 gosu</span><br><span class="line">RUN wget -O /usr/local/bin/gosu &quot;https://github.com/tianon/gosu/releases/download/1.7/gosu-amd64&quot; \</span><br><span class="line">    &amp;&amp; chmod +x /usr/local/bin/gosu \</span><br><span class="line">    &amp;&amp; gosu nobody true</span><br><span class="line"># 设置 CMD，并以另外的用户执行</span><br><span class="line">CMD [ &quot;exec&quot;, &quot;gosu&quot;, &quot;redis&quot;, &quot;redis-server&quot; ]</span><br></pre></td></tr></table></figure></p>
<h6 id="HEALTHCHECK"><a href="#HEALTHCHECK" class="headerlink" title="HEALTHCHECK"></a>HEALTHCHECK</h6><p><code>HEALTHCHECK [option] CMD &lt;command&gt;</code><br><code>HEALTHCHECK NONE</code> 可屏蔽基础镜像的健康检测指令</p>
<p>其命令和ENTTYPOINT类似.<br><code>--interval</code> 间隔时间,两次检测时间间隔,默认30s<br><code>--timeout</code> 超时.健康检测运行超时时间.默认30s<br><code>--retries</code> 重试.默认3次.<br>返回值:<code>0</code>:成功,<code>1</code>:失败 <code>2</code>:保留</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">FROM    nginx</span><br><span class="line">RUN apt-get update  &amp;&amp;  apt-get install -y  curl    &amp;&amp;  rm  -rf /var/lib/apt/lists/*</span><br><span class="line">HEALTHCHECK --interval=15s  --timeout=5s    \</span><br><span class="line">        CMD curl    -fs http://localhost/   ||  exit    1</span><br></pre></td></tr></table></figure>
<h6 id="Dockerfile多阶段构建"><a href="#Dockerfile多阶段构建" class="headerlink" title="Dockerfile多阶段构建"></a>Dockerfile多阶段构建</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">FROM muninn/glide:alpine AS build-env</span><br><span class="line">ADD . /go/src/app</span><br><span class="line">WORKDIR /go/src/app</span><br><span class="line">RUN glide install</span><br><span class="line">RUN go build -v -o /go/src/app/app-server</span><br><span class="line"></span><br><span class="line">FROM alpine</span><br><span class="line">RUN apk add -U tzdata</span><br><span class="line">RUN ln -sf /usr/share/zoneinfo/Asia/Shanghai  /etc/localtime</span><br><span class="line">COPY --from=build-env /go/src/app/app-server /usr/local/bin/app-server</span><br><span class="line">EXPOSE 80</span><br><span class="line">CMD [&quot;app-server&quot;]</span><br></pre></td></tr></table></figure>
<p>首先，第一个 <code>FROM</code> 后边多了个 <code>AS</code> 关键字，可以给这个阶段起个名字。<br>第二部分用了官方的 alpine 镜像，改变时区到中国<br>注意<code>COPY</code> 关键字，它现在可以接受 –from= 这样的参数，从上个我们起名字的阶段复制文件过来。</p>
<h5 id="Dockerfile文件解析"><a href="#Dockerfile文件解析" class="headerlink" title="Dockerfile文件解析"></a>Dockerfile文件解析</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">#docker build -t centos_nginx:v5 .</span><br><span class="line">#docker run --name web_5 -d -p 85:80 centos_nginx:v5 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">FROM centos</span><br><span class="line"></span><br><span class="line">MAINTAINER zili.li</span><br><span class="line"></span><br><span class="line">ADD nginx-1.12.2.tar.gz /usr/local/src</span><br><span class="line"></span><br><span class="line">RUN buildDeps=&apos;gcc gcc-c++ glib make autoconf openssl openssl-devel libxslt-devel gd gd-devel GeoIP GeoIP-devel pcre pcre-devel wget curl&apos; \ </span><br><span class="line">                &amp;&amp; yum -y install $buildDeps \</span><br><span class="line">                &amp;&amp; useradd -M -s /sbin/nologin nginx</span><br><span class="line">#多个用逗号分隔</span><br><span class="line">#docker inspect web_5 的 Mounts下可看到文件挂载信息.</span><br><span class="line">#docker exec -it web_5 /bin/bash 进入容器可查看到挂载的目录,其内容和Mounts是同步的</span><br><span class="line">VOLUME [&quot;/usr/local/nginx/html&quot;]</span><br><span class="line"></span><br><span class="line">WORKDIR /usr/local/src/nginx-1.12.2</span><br><span class="line"></span><br><span class="line">RUN ./configure --user=nginx --group=nginx --prefix=/usr/local/nginx --with-file-aio --with-http_ssl_module --with-http_realip_module --with-http_addition_module --with-http_xslt_module --with-http_image_filter_module --with-http_geoip_module --with-http_sub_module --with-http_dav_module --with-http_flv_module --with-http_mp4_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_auth_request_module --with-http_random_index_module --with-http_secure_link_module --with-http_degradation_module --with-http_stub_status_module \</span><br><span class="line">                &amp;&amp; make \</span><br><span class="line">                &amp;&amp; make install \</span><br><span class="line">                &amp;&amp; rm -rf /usr/local/src/nginx-1.12.2</span><br><span class="line"></span><br><span class="line">#指定了环境变量,所以生成容器的时候 不用在指定路径.直接nginx 即可</span><br><span class="line">ENV PATH /usr/local/nginx/sbin:$PATH                </span><br><span class="line"></span><br><span class="line">EXPOSE 80</span><br><span class="line"></span><br><span class="line">#当ENTRYPOINT和CMD连用时，CMD的命令是ENTRYPOINT命令的参数，两者连用相当于nginx -g &quot;daemon off;&quot;</span><br><span class="line">#如果CMD [&quot;-g&quot;,&quot;daemon on;&quot;] 那么生成的容器将不会处于up状态.但是执行run的时候加入 -g &quot;daemon off;&quot;此参数将会传入给ENTRYPOINT</span><br><span class="line">#容器中的应用都应该以前台执行,容器没有后台概念,-d 表示的后台,是程序的后台,程序完毕容器停止,而不是容器后台.容器都是前台的.</span><br><span class="line">ENTRYPOINT [&quot;nginx&quot;]</span><br><span class="line"></span><br><span class="line">#CMD service nginx start 这是初学经常搞模糊的地方!</span><br><span class="line">#对于容器而言，其启动程序就是容器应用进程，容器就是为了主进程而存在的，主进程退出，容器就失去了存在的意义，从而退出.</span><br><span class="line"># CMD service nginx start 会被理解为 CMD [ &quot;sh&quot;, &quot;-c&quot;, &quot;service nginx start&quot;]</span><br><span class="line">#因此主进程实际上是 sh,那么当 service nginx start 命令结束后，sh 也就结束，sh作为主进程退出了自然就会令容器退出</span><br><span class="line">#正确的做法是直接执行 nginx 可执行文件，并且要求以前台形式运行。比如：CMD [&quot;nginx&quot;, &quot;-g&quot;, &quot;daemon off;&quot;],或CMD /bin/sh -c &apos;nginx -g &quot;daemon off;&quot;&apos;</span><br><span class="line">CMD [&quot;-g&quot;,&quot;daemon off;&quot;]</span><br></pre></td></tr></table></figure>
<h4 id="container"><a href="#container" class="headerlink" title="container"></a>container</h4><h5 id="新建容器"><a href="#新建容器" class="headerlink" title="新建容器"></a>新建容器</h5><p><code>docker run</code> 此命令是用来新建容器<br>例如：<br><code>docker run ubuntu /bin/echo &#39;test&#39;</code> 会输出test后终止容器，终止容器并不是删除容器，所以容器还是存在的，添加<code>--rm</code> 则会临时性的执行，完后删除容器<code>docker run --rm ....</code></p>
<p><code>docker run -it ubuntu /bin/bash</code> 会生成一个伪终端。可通过终端进行简单的操作。同样，此容器也是存在的。docker ps -a查看</p>
<p>docker run流程</p>
<ul>
<li>检查本地是否存在指定的镜像，不存在就从公有仓库下载</li>
<li>利用镜像创建并启动一个容器</li>
<li>分配一个文件系统，并在只读的镜像层外面挂载一层可读写层</li>
<li>从宿主主机配置的网桥接口中桥接一个虚拟接口到容器中去</li>
<li>从地址池配置一个 ip 地址给容器</li>
<li>执行用户指定的应用程序</li>
<li>执行完毕后容器被终止,并不是删除，容器还可以再次启动</li>
</ul>
<h5 id="启动容器"><a href="#启动容器" class="headerlink" title="启动容器"></a>启动容器</h5><p><code>docker container start -i container_id</code>会重新启动一个已终止的容器。</p>
<p><strong>docker container 还有很多命令，建议使用 –help查看使用说明</strong></p>
<h5 id="容器后台运行"><a href="#容器后台运行" class="headerlink" title="容器后台运行"></a>容器后台运行</h5><p><code>docker run -d</code><br>不是用后台运行时，结果输出会到当前主机<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@zili ~]# docker run ubuntu /bin/sh -c &quot;while true; do echo test -d; sleep 1; done&quot;</span><br><span class="line">test -d</span><br><span class="line">test -d</span><br><span class="line">test -d</span><br><span class="line">test -d</span><br></pre></td></tr></table></figure></p>
<p>使用后台运行时候,容器将后台运行，那么如何查看结果呢？<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@zili ~]# docker run -d ubuntu /bin/sh -c &quot;while true; do echo test -d; sleep 1; done&quot;</span><br><span class="line">69931b53bfea873daf9cfeb82c926be84980e41a3c0f62f966b039ffbaa0b1c1</span><br></pre></td></tr></table></figure></p>
<p><code>docker container log container_id</code> 可以来查看相关的容器输出<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@zili ~]# docker container logs 699</span><br><span class="line">test -d</span><br><span class="line">test -d</span><br><span class="line">test -d</span><br><span class="line">test -d</span><br><span class="line">test -d</span><br><span class="line">test -d</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>需要注意的是，容器是否能长久运行和指定的命令有关系，也就是说，命令结束，容器停止，和<code>-d</code>参数并无关系，它只是用来让容器后台运行而已。<br>停止容器运行使用<code>docker container stop container_id</code></p>
<h5 id="进入容器"><a href="#进入容器" class="headerlink" title="进入容器"></a>进入容器</h5><p><code>docker attach</code></p>
<p>不建议使用,因为使用此命令,如果容器是<code>-d</code>后台运行,stdin退出时,容器运行状态将终止.也就是说,此命令进入容器,退出时会导致后台运行的容器终止</p>
<p><code>docker exec -it</code>  不会导致后台运行中的容器终止.推荐使用~!<br>参数说明请使用 <code>docker exec --help</code></p>
<h5 id="导入和导出"><a href="#导入和导出" class="headerlink" title="导入和导出"></a>导入和导出</h5><p><code>docker container export</code> 导出<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@docker ~]# docker ps -a</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS                      PORTS               NAMES</span><br><span class="line">0828d964cc2f        ubuntu:16.04        &quot;/bin/bash&quot;         29 minutes ago      Exited (0) 29 minutes ago                       attach</span><br><span class="line">[root@docker ~]# docker container export attach &gt; attach.tar</span><br><span class="line">[root@docker ~]# ls</span><br><span class="line">anaconda-ks.cfg  attach.tar  docker  myip</span><br></pre></td></tr></table></figure></p>
<p><code>docker image   import</code> 导入<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@docker ~]# cat attach.tar | docker import - test/ubuntu</span><br><span class="line">sha256:e9b17f2d8f7546a1d3e143f684b234ebf2301b95193782d8685d2cdb2f05b2f5</span><br><span class="line">[root@docker ~]# docker images</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">test/ubuntu         latest              e9b17f2d8f75        4 seconds ago       98.4MB</span><br></pre></td></tr></table></figure></p>
<p>也可以通过URL导入<br><code>docker import  http://example.com/exampleimage.tgz example/imagerepo</code></p>
<h5 id="删除容器"><a href="#删除容器" class="headerlink" title="删除容器"></a>删除容器</h5><p><code>docker rm</code><br><code>docker rm -f</code> 删除运行中的容器<br><code>docker container prune</code> 删除所有终止的容器</p>
<h5 id="其他命令"><a href="#其他命令" class="headerlink" title="其他命令"></a>其他命令</h5><p><code>docker diff  container name</code> 查看容器变化<br><code>docker history container:tag</code> 查看container 历史</p>
<h4 id="Repository"><a href="#Repository" class="headerlink" title="Repository"></a>Repository</h4><p>官方repository <a href="https://hub.docker.com/" target="_blank" rel="noopener">Docker hub</a></p>
<p><code>docker search</code> 命令查找官方repository的镜像.<br><code>docker pull</code> 命令把镜像拉取下来</p>
<p> <code>docker login</code> 登录docker hub<br><code>docker logout</code> 退出docker hub<br><code>docker push</code> 推送镜像</p>
<h5 id="私有仓库"><a href="#私有仓库" class="headerlink" title="私有仓库"></a>私有仓库</h5><p><a href="https://yeasy.gitbooks.io/docker_practice/content/repository/registry.html" target="_blank" rel="noopener">略</a></p>
<h4 id="数据管理"><a href="#数据管理" class="headerlink" title="数据管理"></a>数据管理</h4><p>容器管理数据主要有两种方式,数据卷（Volumes）和挂载主机目录(Bind mounts)</p>
<h5 id="数据卷-Volumes"><a href="#数据卷-Volumes" class="headerlink" title="数据卷(Volumes)"></a>数据卷(Volumes)</h5><p>数据卷可以在容器之间共享和重用,<br>数据卷 的修改会立马生效且数据卷 的更新，不会影响镜像<br>数据卷 默认会一直存在，即使容器被删除</p>
<ul>
<li>注意：数据卷 的使用，类似于 Linux 下对目录或文件进行 mount，镜像中的被指定为挂载点的目录中的文件会隐藏掉，能显示看的是挂载的 数据卷。</li>
</ul>
<p>数据卷有 <code>--mount</code>  <code>-v</code> 或者 <code>--volume</code> 但是推荐使用 <code>--mount</code> 参数</p>
<h5 id="创建-删除volume"><a href="#创建-删除volume" class="headerlink" title="创建/删除volume"></a>创建/删除volume</h5><p><code>docker volume create webtest</code> 创建一个webtest的数据卷<br><code>docker volume inspect webtest</code> 查看数据卷<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@docker ~]# docker volume inspect webtest</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;CreatedAt&quot;: &quot;2018-04-15T10:54:40+08:00&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Labels&quot;: &#123;&#125;,</span><br><span class="line">        &quot;Mountpoint&quot;: &quot;/var/lib/docker/volumes/webtest/_data&quot;,</span><br><span class="line">        &quot;Name&quot;: &quot;webtest&quot;,</span><br><span class="line">        &quot;Options&quot;: &#123;&#125;,</span><br><span class="line">        &quot;Scope&quot;: &quot;local&quot;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure></p>
<p><code>docker volume rm webtest</code> 删除数据卷,前提数据卷没有被容器使用</p>
<p>数据卷是独立于容器的,用来做数据初始化的,所以容器的删除不会影响数据卷,若删除容器时想要删除数据卷 则使用<code>docker rm -v</code><br>清理无主的数据卷 <code>docker volume prune</code></p>
<p>涉及删除的操作,<code>思之,慎之而行之</code></p>
<h5 id="启动挂载数据卷的容器"><a href="#启动挂载数据卷的容器" class="headerlink" title="启动挂载数据卷的容器"></a>启动挂载数据卷的容器</h5><p><code>docker run</code>时，使用 <code>--mount</code> 标记来将数据卷挂载到容器里,在一次 docker run 中可以挂载多个数据卷</p>
<p><code>-v后面的映射关系是&quot;宿主机文件/目录:容器里对应的文件/目录&quot;，其中，宿主机上的文件/目录是要提前存在的，容器里对应的文件/目录会自动创建。</code></p>
<p>两种方式本质上没有区别,mount更加清晰直观.<br><code>docker run -it --name web -d -p 80:80 --mount source=webtest,target=/webdir nginx</code><br><code>docker run -it --name web -d -p 80:80 -v webtest:/webdir nginx</code></p>
<p><strong>查看数据卷具体信息</strong><br><code>docker inspect web</code> 数据卷的信息在Mounts下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&quot;Mounts&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;Type&quot;: &quot;volume&quot;,</span><br><span class="line">                &quot;Name&quot;: &quot;webtest&quot;,</span><br><span class="line">                &quot;Source&quot;: &quot;/var/lib/docker/volumes/webtest/_data&quot;,</span><br><span class="line">                &quot;Destination&quot;: &quot;/webdir&quot;,</span><br><span class="line">                &quot;Driver&quot;: &quot;local&quot;,</span><br><span class="line">                &quot;Mode&quot;: &quot;z&quot;,</span><br><span class="line">                &quot;RW&quot;: true,</span><br><span class="line">                &quot;Propagation&quot;: &quot;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br></pre></td></tr></table></figure></p>
<p><code>docker exec -it container /bin/bash</code> 可进入容器查看挂载的目录并新建文件等<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@f24f73d240d9:/# cd webdir/</span><br><span class="line">root@f24f73d240d9:/webdir# touch 123</span><br><span class="line">root@f24f73d240d9:/webdir# df -h</span><br><span class="line">Filesystem              Size  Used Avail Use%   Mounted on</span><br><span class="line">/dev/mapper/centos-root  50G  1.8G   49G   4%   /webdir</span><br><span class="line"></span><br><span class="line">然后退出可在宿主机上看到此文件</span><br><span class="line">[root@docker ~]# cd /var/lib/docker/volumes/webtest/_data/</span><br><span class="line">[root@docker _data]# ls</span><br><span class="line">123</span><br></pre></td></tr></table></figure></p>
<h5 id="挂载目录-Bind-mounts"><a href="#挂载目录-Bind-mounts" class="headerlink" title="挂载目录(Bind mounts)"></a>挂载目录(Bind mounts)</h5><p>多个目录的挂载 多写几次<code>--mount</code>即可</p>
<p><code>[root@docker web]# docker run --name dirbind -d -p 80:80 --mount type=bind,source=/root/web,target=/usr/share/nginx/html nginx</code><br>首先我在root下新建web目录并写个index.html文件将其挂到由nginx镜像生成的容器<code>dirbind</code>的html下.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@docker web]# docker run --name dirbind -d -p 80:80 --mount type=bind,source=/root/web,target=/usr/share/nginx/html nginx</span><br><span class="line">2648c6f9e8ff3660e37dc64b0483bc906e5987082224fb0f8604e2bceef2da65</span><br><span class="line">[root@docker web]# docker exec -it 264 /bin/bash</span><br><span class="line">#此时已进入容器</span><br><span class="line">root@2648c6f9e8ff:/# cd /usr/share/nginx/html</span><br><span class="line">root@2648c6f9e8ff:/usr/share/nginx/html# ls</span><br><span class="line">index.html</span><br><span class="line">#index文件已经挂载上来了. 再次访问nginx就能看到index的内容了.</span><br></pre></td></tr></table></figure>
<p>查看容器信息<br><code>docker inspect dirbind</code> #Mounts部分可看到挂载信息,注意这里,<code>RW: true</code><br>说明是读写权限的,其实还可以挂载个只读的文件.后有说明.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&quot;Mounts&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;Type&quot;: &quot;bind&quot;,</span><br><span class="line">                &quot;Source&quot;: &quot;/root/web&quot;,</span><br><span class="line">                &quot;Destination&quot;: &quot;/usr/share/nginx/html&quot;,</span><br><span class="line">                &quot;Mode&quot;: &quot;&quot;,</span><br><span class="line">                &quot;RW&quot;: true,</span><br><span class="line">                &quot;Propagation&quot;: &quot;rprivate&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br></pre></td></tr></table></figure></p>
<p>只读目录挂载<br><code>docker run --name dirbind -d -p 80:80 --mount type=bind,source=/root/web,target=/usr/share/nginx/html,readonly nginx</code></p>
<h5 id="挂载单个文件"><a href="#挂载单个文件" class="headerlink" title="挂载单个文件"></a>挂载单个文件</h5><p><code>docker run --name bindfile -d -p 80:80 \
--mount type=bind,source=/root/web,target=/usr/share/nginx/html \
--mount type=bind,source=/root/a.html,target=/usr/share/nginx/html/index.html nginx</code><br>第二个<code>--mount</code>是挂载单个文件,其会覆盖挂载的第一个目录下的index文件.</p>
<ul>
<li>单个文件的挂载要求容器内必须也存在此文件</li>
</ul>
<h4 id="docker网络"><a href="#docker网络" class="headerlink" title="docker网络"></a>docker网络</h4><p>docker 网络分为 外部访问和容器互联两种情况</p>
<h5 id="外部访问"><a href="#外部访问" class="headerlink" title="外部访问"></a>外部访问</h5><p>这个已经并不陌生了就是在<code>docker run</code>的时候加上<code>-p</code>参数即可指定本地端口和容器端口<br>一个指定端口上只可以绑定一个容器<br>格式有<code>ip:hostPort:containerPort | ip::containerPort | hostPort:containerPort</code><br> 还可以指定端口格式(tcp或udp)<code>127.0.0.1:1111:1111/udp</code></p>
<ul>
<li>注意:若需多个端口绑定,重复只用<code>-p</code> 即可</li>
</ul>
<p><code>docker port container_id</code> 可查看容器端口映射情况</p>
<p>使用<code>-P</code> 大写的P默认会自动分配端口进行映射.</p>
<h5 id="容器互联"><a href="#容器互联" class="headerlink" title="容器互联"></a>容器互联</h5><p><strong>新建网络</strong><br><code>docker network create -d bridge web-net</code> 新建一个<code>web-net</code>的网络<br><code>-d</code> 参数指定 Docker 网络类型，有 <code>bridge</code> <code>overlay</code>。其中 <code>overlay</code> 网络类型用于 <code>Swarm mode</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@docker ~]# docker network create -d bridge web-net</span><br><span class="line">3a06ef1bde3ea75c16afe1d3024d1a161d33c3c9499646521f30a74992607407</span><br><span class="line">[root@docker ~]# docker network inspect web-net</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Name&quot;: &quot;web-net&quot;,</span><br><span class="line">        &quot;Id&quot;: &quot;3a06ef1bde3ea75c16afe1d3024d1a161d33c3c9499646521f30a74992607407&quot;,</span><br><span class="line">        &quot;Created&quot;: &quot;2018-04-15T14:08:13.044203584+08:00&quot;,</span><br><span class="line">        &quot;Scope&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;bridge&quot;,</span><br><span class="line">        &quot;EnableIPv6&quot;: false,</span><br><span class="line">        &quot;IPAM&quot;: &#123;</span><br><span class="line">            &quot;Driver&quot;: &quot;default&quot;,</span><br><span class="line">            &quot;Options&quot;: &#123;&#125;,</span><br><span class="line">            &quot;Config&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;Subnet&quot;: &quot;172.18.0.0/16&quot;,</span><br><span class="line">                    &quot;Gateway&quot;: &quot;172.18.0.1&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Internal&quot;: false,</span><br><span class="line">        &quot;Attachable&quot;: false,</span><br><span class="line">        &quot;Ingress&quot;: false,</span><br><span class="line">        &quot;ConfigFrom&quot;: &#123;</span><br><span class="line">            &quot;Network&quot;: &quot;&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;ConfigOnly&quot;: false,</span><br><span class="line">        &quot;Containers&quot;: &#123;&#125;,</span><br><span class="line">        &quot;Options&quot;: &#123;&#125;,</span><br><span class="line">        &quot;Labels&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure></p>
<p><strong>容器关联网络</strong><br>通过<code>--network</code> 参数指定容器网络<br><code>docker run --name web1 -d -P  --network web-net nginx</code><br><code>docker run --name web2 -d -P  --network web-net nginx</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[root@docker ~]# docker network inspect web-net</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Name&quot;: &quot;web-net&quot;,</span><br><span class="line">        &quot;Id&quot;: &quot;3a06ef1bde3ea75c16afe1d3024d1a161d33c3c9499646521f30a74992607407&quot;,</span><br><span class="line">        &quot;Created&quot;: &quot;2018-04-15T14:08:13.044203584+08:00&quot;,</span><br><span class="line">        &quot;Scope&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;bridge&quot;,</span><br><span class="line">        &quot;EnableIPv6&quot;: false,</span><br><span class="line">        &quot;IPAM&quot;: &#123;</span><br><span class="line">            &quot;Driver&quot;: &quot;default&quot;,</span><br><span class="line">            &quot;Options&quot;: &#123;&#125;,</span><br><span class="line">            &quot;Config&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;Subnet&quot;: &quot;172.18.0.0/16&quot;,</span><br><span class="line">                    &quot;Gateway&quot;: &quot;172.18.0.1&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Internal&quot;: false,</span><br><span class="line">        &quot;Attachable&quot;: false,</span><br><span class="line">        &quot;Ingress&quot;: false,</span><br><span class="line">        &quot;ConfigFrom&quot;: &#123;</span><br><span class="line">            &quot;Network&quot;: &quot;&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;ConfigOnly&quot;: false,</span><br><span class="line">        &quot;Containers&quot;: &#123;</span><br><span class="line">            &quot;21250caa4838de429eeda541aab9d4e6e0697a4b9038d9656e0ee318db9f2636&quot;: &#123;</span><br><span class="line">                &quot;Name&quot;: &quot;web2&quot;,</span><br><span class="line">                &quot;EndpointID&quot;: &quot;46cac28abeef408daa1351bd2c376376928c82c1bb2836cb729adcd7379022ce&quot;,</span><br><span class="line">                &quot;MacAddress&quot;: &quot;02:42:ac:12:00:02&quot;,</span><br><span class="line">                &quot;IPv4Address&quot;: &quot;172.18.0.2/16&quot;,</span><br><span class="line">                &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;aca3aa6558188c41a2ab1f79993d845d6cea392fcc8c61d8acc0bc9864550834&quot;: &#123;</span><br><span class="line">                &quot;Name&quot;: &quot;web1&quot;,</span><br><span class="line">                &quot;EndpointID&quot;: &quot;26e27856326d3bc04f29ecaf083dab789c80b0f64ce7c09159df31e896052ca6&quot;,</span><br><span class="line">                &quot;MacAddress&quot;: &quot;02:42:ac:12:00:03&quot;,</span><br><span class="line">                &quot;IPv4Address&quot;: &quot;172.18.0.3/16&quot;,</span><br><span class="line">                &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Options&quot;: &#123;&#125;,</span><br><span class="line">        &quot;Labels&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure></p>
<p>进入容器中<code>docker exec -it /bin/bash</code><br>ubuntu容器没有ping则安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apt-get update</span><br><span class="line">apt install net-tools       # ifconfig</span><br><span class="line">apt install iputils-ping     # ping</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@0b8f77731024:~# ping web2</span><br><span class="line">PING net2 (172.18.0.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from web2.web-net (172.18.0.2): icmp_seq=1 ttl=64 time=0.085 ms</span><br><span class="line">64 bytes from web2.web-net (172.18.0.2): icmp_seq=2 ttl=64 time=0.043 ms</span><br></pre></td></tr></table></figure>
<p>如果有过个容器要互联,如果你有多个容器之间需要互相连接，<code>Docker Compose</code>了解一下.</p>
<h5 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h5><p>进入容器中执行<code>mount</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@0b8f77731024:~# mount</span><br><span class="line">/dev/mapper/centos-root on /etc/resolv.conf type xfs (rw,relatime,attr2,inode64,noquota)</span><br><span class="line">/dev/mapper/centos-root on /etc/hostname type xfs (rw,relatime,attr2,inode64,noquota)</span><br><span class="line">/dev/mapper/centos-root on /etc/hosts type xfs (rw,relatime,attr2,inode64,noquota)</span><br></pre></td></tr></table></figure></p>
<p>可以看到,dns,主机名,hosts文件是被挂载上去的,这样只要宿主机有变更,那么容器就能立即得到更新.<br>同理,如果有需要可单独见文件进行挂载,并指向容器内相关文件.</p>
<p><strong>还有一种方式</strong> 通过<code>/etc/docker/daemon.json</code>来配置,这样影响所有容器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;dns&quot; : [</span><br><span class="line">    &quot;114.114.114.114&quot;,</span><br><span class="line">    &quot;8.8.8.8&quot;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果想要手动指定的话.在<code>docker run</code>的时候可以添加参数<br><code>-h HOSTNAME</code>或者 <code>--hostname=HOSTNAME</code>设定容器的主机名,但它在容器外部看不到，既不会在 docker container ls 中显示，也不会在其他的容器的 /etc/hosts 看到。<br><code>--dns=IP_ADDRESS</code> 添加 DNS 服务器到容器的<code>/etc/resolv.conf</code> 中，让容器用这个服务器来解析所有不在 /etc/hosts 中的主机名。<br><code>--dns-search=DOMAIN</code>设定容器的搜索域，当设定搜索域为 <code>.example.com</code>时，在搜索一个名为 host 的主机时，DNS 不仅搜索 host，还会搜索 <code>host.example.com</code></p>
<h5 id="高级网络配置"><a href="#高级网络配置" class="headerlink" title="高级网络配置"></a>高级网络配置</h5><p><a href="https://yeasy.gitbooks.io/docker_practice/content/advanced_network/" target="_blank" rel="noopener">略，参考链接</a></p>
<h4 id="Docker-Compose"><a href="#Docker-Compose" class="headerlink" title="Docker Compose"></a>Docker Compose</h4><p>Docker Compose 是 Docker 官方编排（Orchestration）项目之一，负责快速的部署分布式应用</p>
<p>我们知道通过Dockerfile可以实现单独的一个应用容器.<br>实际,一个项目可能需要多个容器相互配合来完成.比如一个动态网站,除了页面还有数据库等等.</p>
<p>compose两个重要的概念:</p>
<pre><code>- 服务(service) : 一个应用容器，实际上可以包括若干运行相同镜像的容器实例
- 项目(project) :　一组关联容器组成的完整业务单元
</code></pre><h5 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h5><p>二进制安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo curl -L https://github.com/docker/compose/releases/download/1.17.1/docker-compose-`uname -s`-`uname -m` &gt; /usr/local/bin/docker-compose</span><br><span class="line"></span><br><span class="line">sudo chmod +x /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure>
<p>pip安装<br><code>sudo pip install -U docker-compose</code></p>
<p>容器中执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -L https://github.com/docker/compose/releases/download/1.8.0/run.sh &gt; /usr/local/bin/docker-compose</span><br><span class="line"></span><br><span class="line">chmod +x /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure>
<h5 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">├── docker_compose</span><br><span class="line">│   ├── app.py</span><br><span class="line">│   ├── docker-compose.yml</span><br><span class="line">│   └── Dockerfile</span><br></pre></td></tr></table></figure>
<p><code>app.py</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask</span><br><span class="line">from redis import Redis</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">redis = Redis(host=&apos;redis&apos;, port=6379)</span><br><span class="line"></span><br><span class="line">@app.route(&apos;/&apos;)</span><br><span class="line">def hello():</span><br><span class="line">    count = redis.incr(&apos;hits&apos;)</span><br><span class="line">    return &apos;Hello World! 该页面已被访问 &#123;&#125; 次。\n&apos;.format(count)</span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    app.run(host=&quot;0.0.0.0&quot;, debug=True)</span><br></pre></td></tr></table></figure>
<p><code>Dockerfile</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FROM python:3.6-alpine</span><br><span class="line">ADD . /code</span><br><span class="line">WORKDIR /code</span><br><span class="line">RUN pip install redis flask</span><br><span class="line">CMD [&quot;python&quot;, &quot;app.py&quot;]</span><br></pre></td></tr></table></figure>
<p><code>docker-compose.yml</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">version: &apos;3&apos;</span><br><span class="line">services:</span><br><span class="line"></span><br><span class="line">  web:</span><br><span class="line">    build: .</span><br><span class="line">    ports:</span><br><span class="line">     - &quot;5000:5000&quot;</span><br><span class="line"></span><br><span class="line">  redis:</span><br><span class="line">    image: &quot;redis:alpine&quot;</span><br></pre></td></tr></table></figure>
<p>然后执行<code>docker-compose up</code> 即可</p>
<h5 id="命令参数说明"><a href="#命令参数说明" class="headerlink" title="命令参数说明"></a>命令参数说明</h5><p>docker-compose</p>
<pre><code>- `-f, --file FILE` 指定使用的 Compose 模板文件，默认为 `docker-compose.yml`，可以多次指定。
- `-p, --project-name NAME` 指定项目名称，默认将使用所在目录名称作为项目名。
- `--x-networking` 使用 Docker 的可拔插网络后端特性
- `--x-network-driver DRIVER` 指定网络后端的驱动，默认为 bridge
- `--verbose` 输出更多调试信息
- `-v, --version` 打印版本并退出
</code></pre><p>docker-compose <code>build</code><br>用来创建或重新创建服务使用的镜像<br>docker-compose build service_a<br>创建一个镜像名叫service_a</p>
<p>docker-compose <code>kill</code><br>用于通过容器发送SIGKILL信号强行停止服务</p>
<p>docker-compose <code>logs</code><br>显示service的日志信息</p>
<p>docker-compose pause/unpause<br>docker-compose pause #暂停服务<br>docker-compose unpause #恢复被暂停的服务</p>
<p>docker-compose <code>port</code><br>用于查看服务中的端口与物理机的映射关系<br>docker-compose port nginx_web 80<br>查看服务中80端口映射到物理机上的那个端口</p>
<p>dokcer-compose <code>ps</code><br>用于显示当前项目下的容器<br>注意，此命令与docker ps不同作用，此命令会显示停止后的容器（状态为Exited），只征对某个项目。</p>
<p>docker-compose <code>pull</code><br>用于拉取服务依赖的镜像</p>
<p>docker-compose <code>restart</code><br>用于重启某个服务中的所有容器<br>docker-compose restart service_name<br>只有正在运行的服务可以使用重启命令，停止的服务是不可以重启</p>
<p>docker-compose <code>rm</code><br>删除停止的服务（服务里的容器）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-f #强制删除</span><br><span class="line">-v #删除与容器相关的卷（volumes）</span><br></pre></td></tr></table></figure></p>
<p>docker-compose <code>run</code><br>用于在服务中运行一个一次性的命令。这个命令会新建一个容器，它的配置和srvice的配置相同。<br>但两者之间还是有两点不同之处<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1、run指定的命令会直接覆盖掉service配置中指定的命令</span><br><span class="line">2、run命令启动的容器不会创建在service配置中指定的端口，如果需要指定使用--service-ports指定</span><br></pre></td></tr></table></figure></p>
<p>docker-compose start/stop<br>docker-compose start 启动运行某个服务的所有容器<br>docker-compose stop 启动运行某个服务的所有容器</p>
<p>docker-compose scale<br>指定某个服务启动的容器个数</p>
<h5 id="实例一"><a href="#实例一" class="headerlink" title="实例一"></a>实例一</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@docker web-nginx]# tree</span><br><span class="line">.</span><br><span class="line">├── docker-compose.yml</span><br><span class="line">├── nginx</span><br><span class="line">│   └── nginx.conf</span><br><span class="line">└── webserver</span><br><span class="line">    └── index.html</span><br></pre></td></tr></table></figure>
<p><code>nginx.conf</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">#user  nginx;</span><br><span class="line">worker_processes  1;</span><br><span class="line">error_log  /var/log/nginx_error.log warn;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</span><br><span class="line">                      &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class="line">                      &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx_access.log  main;</span><br><span class="line">    client_max_body_size 10m;  </span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    #gzip  on;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  localhost;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root   /webserver;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">    #include /usr/local/nginx/conf.d/*.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>index.html</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;welcome to nginx web stie&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">   &lt;h2&gt;compose test1---1&lt;/h2&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p><code>docker-compose.yml</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">version: &quot;3&quot; #指定语法版本</span><br><span class="line">services: #定义服务</span><br><span class="line">  nginx:</span><br><span class="line">    container_name: web-nginx #容器名字</span><br><span class="line">    image: centos_nginx:v5 #依赖镜像</span><br><span class="line">    restart: always</span><br><span class="line">    ports:  #端口映射</span><br><span class="line">      - 80:80</span><br><span class="line">    volumes:</span><br><span class="line">      #映射文件到容器.第一个是web的,在nginx通过root指定路径.第二个是配置文件.</span><br><span class="line">      #如果不想指定web,可直接映射到nginx默认html路径.nginx配置不需要指定路径了</span><br><span class="line">      #- ./webserver:/usr/local/nginx/html</span><br><span class="line">      - ./webserver:/webserver</span><br><span class="line">      - ./nginx/nginx.conf:/usr/local/nginx/conf/nginx.conf</span><br></pre></td></tr></table></figure>
<h5 id="实例二"><a href="#实例二" class="headerlink" title="实例二"></a>实例二</h5><p>创建自定义网络test<code>docker network create --subnet=172.88.0.0/16 test</code><br>网络名test和ip会在docker-compose中使用,用来指定网络和IP,同时IP与nginx负载有关</p>
<h6 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">├── docker-compose.yml</span><br><span class="line">├── etc</span><br><span class="line">│   └── localtime</span><br><span class="line">├── nginx</span><br><span class="line">│   ├── Dockerfile</span><br><span class="line">│   ├── nginx-1.12.2.tar.gz</span><br><span class="line">│   └── nginx.conf</span><br><span class="line">├── tomcat</span><br><span class="line">│   ├── apache-tomcat-8.5.24.tar.gz</span><br><span class="line">│   ├── Dockerfile</span><br><span class="line">│   └── jdk-8u45-linux-x64.tar.gz</span><br><span class="line">└── webserver</span><br><span class="line">    ├── tomcatA</span><br><span class="line">    │   └── index.jsp</span><br><span class="line">    └── tomcatB</span><br><span class="line">        └── index.jsp</span><br></pre></td></tr></table></figure>
<h6 id="nginx"><a href="#nginx" class="headerlink" title="nginx"></a>nginx</h6><p><code>nginx.conf</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">#user  nginx;</span><br><span class="line">worker_processes  1;</span><br><span class="line">error_log  /var/log/nginx_error.log warn;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    upstream tomcat  &#123; </span><br><span class="line">      server 172.88.0.11:8080; </span><br><span class="line">      server 172.88.0.22:8080; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</span><br><span class="line">                      &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class="line">                      &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx_access.log  main;</span><br><span class="line">    client_max_body_size 10m;  </span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    #gzip  on;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  tomcat;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            #root   /webserver;</span><br><span class="line">            proxy_pass http://tomcat;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    #include /usr/local/nginx/conf.d/*.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Dcokerfile</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">FROM centos</span><br><span class="line"></span><br><span class="line">MAINTAINER zili.li</span><br><span class="line"></span><br><span class="line">ADD nginx-1.12.2.tar.gz /usr/local/src</span><br><span class="line"></span><br><span class="line">RUN buildDeps=&apos;gcc gcc-c++ glib make autoconf openssl openssl-devel libxslt-devel gd gd-devel GeoIP GeoIP-devel pcre pcre-devel wget curl&apos; \ </span><br><span class="line">                &amp;&amp; yum -y install $buildDeps \</span><br><span class="line">                &amp;&amp; useradd -M -s /sbin/nologin nginx</span><br><span class="line"></span><br><span class="line">VOLUME [&quot;/usr/local/nginx/html&quot;]</span><br><span class="line"></span><br><span class="line">WORKDIR /usr/local/src/nginx-1.12.2</span><br><span class="line"></span><br><span class="line">RUN ./configure --user=nginx --group=nginx --prefix=/usr/local/nginx --with-file-aio --with-http_ssl_module --with-http_realip_module --with-http_addition_module --with-http_xslt_module --with-http_image_filter_module --with-http_geoip_module --with-http_sub_module --with-http_dav_module --with-http_flv_module --with-http_mp4_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_auth_request_module --with-http_random_index_module --with-http_secure_link_module --with-http_degradation_module --with-http_stub_status_module \</span><br><span class="line">                &amp;&amp; make \</span><br><span class="line">                &amp;&amp; make install \</span><br><span class="line">                &amp;&amp; rm -rf /usr/local/src/nginx-1.12.2</span><br><span class="line"></span><br><span class="line">ENV PATH /usr/local/nginx/sbin:$PATH                </span><br><span class="line"></span><br><span class="line">EXPOSE 80</span><br><span class="line"></span><br><span class="line">ENTRYPOINT [&quot;nginx&quot;]</span><br><span class="line"></span><br><span class="line">CMD [&quot;-g&quot;,&quot;daemon off;&quot;]</span><br></pre></td></tr></table></figure>
<h6 id="tomcat"><a href="#tomcat" class="headerlink" title="tomcat"></a>tomcat</h6><p><code>Dcokerfile</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">FROM centos</span><br><span class="line"></span><br><span class="line">ADD jdk-8u45-linux-x64.tar.gz /usr/local</span><br><span class="line"></span><br><span class="line">ENV RUN_AS_USER=root</span><br><span class="line">ENV JAVA_HOME /usr/local/jdk1.8.0_45</span><br><span class="line">ENV CLASS_HOME=/usr/local/jdk1.8.0_45/lib:$JAVA_HOME/jre/lib</span><br><span class="line">ENV CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar:$JRE_HOME/lib:$CLASSPATH</span><br><span class="line">ENV PATH=$PATH:$JAVA_HOME/bin</span><br><span class="line"></span><br><span class="line">ADD apache-tomcat-8.5.24.tar.gz /usr/local</span><br><span class="line"></span><br><span class="line">EXPOSE 8080</span><br><span class="line">ENTRYPOINT [&quot;/usr/local/apache-tomcat-8.5.24/bin/catalina.sh&quot;, &quot;run&quot;]</span><br></pre></td></tr></table></figure>
<h6 id="docker-compose"><a href="#docker-compose" class="headerlink" title="docker-compose"></a>docker-compose</h6><p><code>docker-compose.yml</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">version: &quot;3&quot;</span><br><span class="line">services:</span><br><span class="line">  nginx:</span><br><span class="line">    hostname: nginx</span><br><span class="line">    build: ./nginx</span><br><span class="line">    restart: always</span><br><span class="line">    ports:</span><br><span class="line">      - 80:80</span><br><span class="line">    networks:</span><br><span class="line">      test:</span><br><span class="line">        ipv4_address: 172.88.0.88</span><br><span class="line">    volumes:</span><br><span class="line">      - ./nginx/nginx.conf:/usr/local/nginx/conf/nginx.conf</span><br><span class="line">      - ./etc/localtime:/etc/localtime</span><br><span class="line">    depends_on:</span><br><span class="line">      - tomcat1</span><br><span class="line">      - tomcat2</span><br><span class="line"></span><br><span class="line">  tomcat1:</span><br><span class="line">    hostname: tomcat1</span><br><span class="line">    build: ./tomcat</span><br><span class="line">    restart: always</span><br><span class="line">    volumes:</span><br><span class="line">      - ./webserver/tomcatA:/usr/local/apache-tomcat-8.5.24/webapps/ROOT</span><br><span class="line">      - ./etc/localtime:/etc/localtime</span><br><span class="line">    networks:</span><br><span class="line">      test:</span><br><span class="line">        ipv4_address: 172.88.0.11</span><br><span class="line"></span><br><span class="line">  tomcat2:</span><br><span class="line">    hostname: tomcat2</span><br><span class="line">    build: ./tomcat</span><br><span class="line">    restart: always</span><br><span class="line">    volumes:</span><br><span class="line">      - ./webserver/tomcatB/index.jsp:/usr/local/apache-tomcat-8.5.24/webapps/ROOT/index.jsp</span><br><span class="line">      - ./etc/localtime:/etc/localtime</span><br><span class="line">    networks:</span><br><span class="line">      test:</span><br><span class="line">        ipv4_address: 172.88.0.22</span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  test:</span><br><span class="line">    external: true</span><br></pre></td></tr></table></figure>
<p><code>docker-compose up</code></p>
<h4 id="docker-machine"><a href="#docker-machine" class="headerlink" title="docker machine"></a>docker machine</h4><h5 id="安装-2"><a href="#安装-2" class="headerlink" title="安装"></a>安装</h5><ul>
<li>linux<br><a href="https://github.com/docker/machine/releases" target="_blank" rel="noopener">官网</a>下载相关安装包,安装即可 .</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo curl -L https://github.com/docker/machine/releases/download/v0.13.0/docker-machine-`uname -s`-`uname -m` &gt; /usr/local/bin/docker-machine</span><br><span class="line">$ sudo chmod +x /usr/local/bin/docker-machine</span><br></pre></td></tr></table></figure>
<h5 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker-machine create \</span><br><span class="line">    --driver vmwarevsphere \</span><br><span class="line">    --vmwarevsphere-vcenter=xxx.xxx.xxx.xxx \</span><br><span class="line">    --vmwarevsphere-username=xxxxx \</span><br><span class="line">    --vmwarevsphere-password=xxxxxxx \</span><br><span class="line">    --vmwarevsphere-cpu-count=1 \</span><br><span class="line">    --vmwarevsphere-memory-size=512 \</span><br><span class="line">    --vmwarevsphere-disk-size=10240 \</span><br><span class="line">    TestDcokerMa</span><br></pre></td></tr></table></figure>
<p><code>driver vmwarevsphere</code><br>我们的虚拟机 host 上安装的是 vmware 的产品 vSphere，因此需要给 Docker Machine 提供对应的驱动，这样才能够在上面安装新的虚拟机。<br><code>--vmwarevsphere-vcenter=xxx.xxx.xxx.xxx</code><br><code>--vmwarevsphere-username=root</code><br><code>--vmwarevsphere-password=12345678</code><br>上面三行分别指定了虚拟机 host 的 IP 地址、用户名和密码。</p>
<p><code>--vmwarevsphere-cpu-count=1</code><br><code>--vmwarevsphere-memory-size=512</code><br><code>--vmwarevsphere-disk-size=10240</code><br>上面三行则分别指定了新创建的虚拟机占用的 cpu、内存和磁盘资源。<br><code>TestDcokerMa</code><br>最后一个参数则是新建虚拟机的名称。</p>
<p><a href="https://docs.docker.com/machine/" target="_blank" rel="noopener">详细使用参考官网</a><br>​    </p>

      
    </div>
    
    
    
    <div>
      
        
<div class="my_post_copyright">
  <script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

  <!-- JS库 sweetalert 可修改路径 -->
  <script type="text/javascript" src="http://jslibs.wuxubj.cn/sweetalert_mini/jquery-1.7.1.min.js"></script>
  <script src="http://jslibs.wuxubj.cn/sweetalert_mini/sweetalert.min.js"></script>
  <link rel="stylesheet" type="text/css" href="http://jslibs.wuxubj.cn/sweetalert_mini/sweetalert.mini.css">
  <p><span>本文标题:</span><a href="/2018/05/15/docker学习/">docker学习</a></p>
  <p><span>文章作者:</span><a href="/" title="访问 zili 的个人博客">zili</a></p>
  <p><span>发布时间:</span>2018年05月15日 - 21:05</p>
  <p><span>原始链接:</span><a href="/2018/05/15/docker学习/" title="docker学习">https://dl1548.github.io/2018/05/15/docker学习/</a>
    <span class="copy-path" title="点击复制文章链接"><i class="fa fa-clipboard" data-clipboard-text="https://dl1548.github.io/2018/05/15/docker学习/" aria-label="复制成功！"></i></span>
  </p>
  <p><span>许可协议:</span> <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">CC BY-NC-ND 4.0</a> 转载请保留原文链接及作者。</p>
</div>
<script>
    var clipboard = new Clipboard('.fa-clipboard');
    clipboard.on('success', $(function(){
      $(".fa-clipboard").click(function(){
        swal({
          title: "",
          text: '复制成功',
          html: false,
          timer: 500,
          showConfirmButton: false
        });
      });
    }));
</script>


      
    </div>

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>如果您觉得文章对您有帮助的话. 感谢支持~!</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.jpg" alt="zili 微信支付">
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt="zili 支付宝">
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/docker/" rel="tag"><i class="fa fa-tag"></i> docker</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/05/09/jenkins-pipeline/" rel="next" title="jenkins pipeline">
                <i class="fa fa-chevron-left"></i> jenkins pipeline
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/06/22/uWSGI-Nginx部署Django项目/" rel="prev" title="uWSGI+Nginx部署Django项目">
                uWSGI+Nginx部署Django项目 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  
    <div class="comments" id="comments">
      <div id="SOHUCS"></div>
    </div>
  


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/zili.jpg" alt="zili">
            
              <p class="site-author-name" itemprop="name">zili</p>
              <p class="site-description motion-element" itemprop="description">众生皆苦</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">69</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">44</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/dl1548" target="_blank" title="GitHub">
                    
                      <i class="fa fa-fw fa-github"></i></a>
                </span>
              
            
          </div>

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-globe"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://example.com/" title="暂" target="_blank">暂</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://example.com/" title="无" target="_blank">无</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://example.com/" title="友" target="_blank">友</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://example.com/" title="链" target="_blank">链</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#安装"><span class="nav-number">1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建用户组"><span class="nav-number">2.</span> <span class="nav-text">创建用户组</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#镜像加速"><span class="nav-number">3.</span> <span class="nav-text">镜像加速</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#image"><span class="nav-number">4.</span> <span class="nav-text">image</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#构建镜像"><span class="nav-number">4.1.</span> <span class="nav-text">构建镜像</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Dockerfile"><span class="nav-number">4.2.</span> <span class="nav-text">Dockerfile</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#构建"><span class="nav-number">4.2.1.</span> <span class="nav-text">构建</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#实例解析"><span class="nav-number">4.2.2.</span> <span class="nav-text">实例解析</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#build中的点"><span class="nav-number">4.2.3.</span> <span class="nav-text">build中的点.</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Dockerfile其他指令"><span class="nav-number">4.3.</span> <span class="nav-text">Dockerfile其他指令</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#COPY"><span class="nav-number">4.3.1.</span> <span class="nav-text">COPY</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ADD"><span class="nav-number">4.3.2.</span> <span class="nav-text">ADD</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#CMD"><span class="nav-number">4.3.3.</span> <span class="nav-text">CMD</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ENTRYPOINT"><span class="nav-number">4.3.4.</span> <span class="nav-text">ENTRYPOINT</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ENV"><span class="nav-number">4.3.5.</span> <span class="nav-text">ENV</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ARG变量"><span class="nav-number">4.3.6.</span> <span class="nav-text">ARG变量</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#VOLUME"><span class="nav-number">4.3.7.</span> <span class="nav-text">VOLUME</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#EXPOSE"><span class="nav-number">4.3.8.</span> <span class="nav-text">EXPOSE</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#WORKDIR"><span class="nav-number">4.3.9.</span> <span class="nav-text">WORKDIR</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ONBUILD"><span class="nav-number">4.3.10.</span> <span class="nav-text">ONBUILD</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#USER"><span class="nav-number">4.3.11.</span> <span class="nav-text">USER</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#HEALTHCHECK"><span class="nav-number">4.3.12.</span> <span class="nav-text">HEALTHCHECK</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Dockerfile多阶段构建"><span class="nav-number">4.3.13.</span> <span class="nav-text">Dockerfile多阶段构建</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Dockerfile文件解析"><span class="nav-number">4.4.</span> <span class="nav-text">Dockerfile文件解析</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#container"><span class="nav-number">5.</span> <span class="nav-text">container</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#新建容器"><span class="nav-number">5.1.</span> <span class="nav-text">新建容器</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#启动容器"><span class="nav-number">5.2.</span> <span class="nav-text">启动容器</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#容器后台运行"><span class="nav-number">5.3.</span> <span class="nav-text">容器后台运行</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#进入容器"><span class="nav-number">5.4.</span> <span class="nav-text">进入容器</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#导入和导出"><span class="nav-number">5.5.</span> <span class="nav-text">导入和导出</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#删除容器"><span class="nav-number">5.6.</span> <span class="nav-text">删除容器</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#其他命令"><span class="nav-number">5.7.</span> <span class="nav-text">其他命令</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Repository"><span class="nav-number">6.</span> <span class="nav-text">Repository</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#私有仓库"><span class="nav-number">6.1.</span> <span class="nav-text">私有仓库</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#数据管理"><span class="nav-number">7.</span> <span class="nav-text">数据管理</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#数据卷-Volumes"><span class="nav-number">7.1.</span> <span class="nav-text">数据卷(Volumes)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#创建-删除volume"><span class="nav-number">7.2.</span> <span class="nav-text">创建/删除volume</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#启动挂载数据卷的容器"><span class="nav-number">7.3.</span> <span class="nav-text">启动挂载数据卷的容器</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#挂载目录-Bind-mounts"><span class="nav-number">7.4.</span> <span class="nav-text">挂载目录(Bind mounts)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#挂载单个文件"><span class="nav-number">7.5.</span> <span class="nav-text">挂载单个文件</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#docker网络"><span class="nav-number">8.</span> <span class="nav-text">docker网络</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#外部访问"><span class="nav-number">8.1.</span> <span class="nav-text">外部访问</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#容器互联"><span class="nav-number">8.2.</span> <span class="nav-text">容器互联</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#DNS"><span class="nav-number">8.3.</span> <span class="nav-text">DNS</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#高级网络配置"><span class="nav-number">8.4.</span> <span class="nav-text">高级网络配置</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Docker-Compose"><span class="nav-number">9.</span> <span class="nav-text">Docker Compose</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#安装-1"><span class="nav-number">9.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#使用"><span class="nav-number">9.2.</span> <span class="nav-text">使用</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#命令参数说明"><span class="nav-number">9.3.</span> <span class="nav-text">命令参数说明</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#实例一"><span class="nav-number">9.4.</span> <span class="nav-text">实例一</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#实例二"><span class="nav-number">9.5.</span> <span class="nav-text">实例二</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#目录结构"><span class="nav-number">9.5.1.</span> <span class="nav-text">目录结构</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#nginx"><span class="nav-number">9.5.2.</span> <span class="nav-text">nginx</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#tomcat"><span class="nav-number">9.5.3.</span> <span class="nav-text">tomcat</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#docker-compose"><span class="nav-number">9.5.4.</span> <span class="nav-text">docker-compose</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#docker-machine"><span class="nav-number">10.</span> <span class="nav-text">docker machine</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#安装-2"><span class="nav-number">10.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#使用-1"><span class="nav-number">10.2.</span> <span class="nav-text">使用</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

<!-- music -->
      <br><br>cn.zili.lee@gmail.com
    </div>

  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zili 豫ICP备17037562号</span>

  
</div>



        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  




  
    <script type="text/javascript">
    (function(){
      var appid = 'cythS3OwJ';
      var conf = 'bb066f28faf1b1f48464e7f77b1e4c46';
      var width = window.innerWidth || document.documentElement.clientWidth;
      if (width < 960) {
      window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>'); } else { var loadJs=function(d,a){var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("charset","UTF-8");b.setAttribute("src",d);if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};loadJs("https://changyan.sohu.com/upload/changyan.js",function(){
        window.changyan.api.config({appid:appid,conf:conf})});
      }
    })();
    </script>
    <script type="text/javascript" src="https://assets.changyan.sohu.com/upload/plugins/plugins.count.js"></script>
  





  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

</body>
</html>
